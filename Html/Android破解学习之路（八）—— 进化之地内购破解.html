原文链接：http://www.cnblogs.com/kexing/archive/2018/06/27/9231454.html
<p>最近在TapTap闲逛，看到了进化之地这款游戏，TapTap上有两个进化之地，一个是在TapTap直接购买的，另外一个则是试玩版，玩到中间就会有个购买完整版。<br />
试玩版连接：https://www.taptap.com/app/33024<br />
闲来无事，便是下了试玩版来玩，感觉还不错，到中间的时候，就是要提示要购买完整版，看了一下界面，发现是咪咕游戏的SDK，就想着搞事情。<br />
咪咕游戏里面有支付宝支付的选项，我选择之后，点击了取消，发现了一个Toast提示，<span style="font-size: 16px;"><span style="color: red;">短信发送失败,请尝试其它支付方式</span>，</span><br />
不过，当我丢入<a class="relatedlink" href="https://www.52pojie.cn/thread-319641-1-1.html" target="_blank">Androidkiller</a>中去反编译的时候，忽然想起，签名不同，无法覆盖安装啊，无奈。</p>
<p><span style="font-size: 16px;">试玩到中间，会提示一个购买完整版，选择支付方式为支付宝，之后返回，提示&ldquo;短信发送失败,请尝试其它支付方式&rdquo;，一个Toast</span></p>
<p><span style="font-size: 16px;">以此为关键字找到了两处关键代码</span></p>
<p><img src="https://images2018.cnblogs.com/blog/1210268/201806/1210268-20180626214307100-2018195806.png" alt="" width="975" height="446" /></p>
<p><span style="font-size: 16px;">但是不确定是哪一个，所以我们将其中的某一个的内容稍微修改一下，接着编译安装到手机上，之后便是可以确定为CallSMSPay$3这个smali文件，进到里面观察，可以发现没有我们想要的支付成功，撤退。，</span></p>
<p><span style="font-size: 16px;">继续寻找其他方法，想到咪咕游戏的破解方法，搜索onresult，发现一堆文件，根本就无从下手，没办法，只好一个个看下去，看完整个头都大了，撤退。</span></p>
<p><span style="font-size: 16px;">搜索onbilling，没有结果</span></p>
<p><span style="font-size: 16px;">搜索支付成功，看到了一个关键文件</span></p>
<p><img src="https://images2018.cnblogs.com/blog/1210268/201806/1210268-20180626215056787-2088433316.png" alt="" width="960" height="514" /></p>
<p><span style="font-size: 16px;">去看了一下它的伪java代码，发现有几个if语句，猜测了一下，将bool1赋值为true，然而测试的时候以失败告终。</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('a5fe27f3-6efe-4aea-b319-879cda8b15d1')"><span style="font-size: 16px;"><img id="code_img_closed_a5fe27f3-6efe-4aea-b319-879cda8b15d1" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_a5fe27f3-6efe-4aea-b319-879cda8b15d1" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('a5fe27f3-6efe-4aea-b319-879cda8b15d1',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" /></span>
<div id="cnblogs_code_open_a5fe27f3-6efe-4aea-b319-879cda8b15d1" class="cnblogs_code_hide">
<pre><span style="font-size: 16px;"><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.locojoy.function;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.Toast;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.adobe.fre.FREContext;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.adobe.fre.FREFunction;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.adobe.fre.FREInvalidObjectException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.adobe.fre.FREObject;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.adobe.fre.FRETypeMismatchException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.adobe.fre.FREWrongThreadException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.locojoy.CallBackImpl;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.locojoy.Util;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.umeng.socialize.utils.Log;

</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> SMSPayResult
  </span><span style="color: #0000ff;">implements</span><span style="color: #000000;"> FREFunction
{
  </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> FREObject call(FREContext paramFREContext, FREObject[] paramArrayOfFREObject)
  {
    bool3 </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    bool4 </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    bool5 </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    bool2 </span>= <span style="color: #0000ff;">false</span><span style="color: #000000;">;
    str </span>= "10000"<span style="color: #000000;">;
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;">
    {
      bool1 </span>= paramArrayOfFREObject[0<span style="color: #000000;">].getAsBool();
      bool2 </span>=<span style="color: #000000;"> bool1;
      bool3 </span>=<span style="color: #000000;"> bool1;
      bool4 </span>=<span style="color: #000000;"> bool1;
      bool5 </span>=<span style="color: #000000;"> bool1;
      paramArrayOfFREObject </span>= paramArrayOfFREObject[1<span style="color: #000000;">].getAsString();
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FREWrongThreadException paramArrayOfFREObject)
    {
      </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (;;)
      {
        bool1 </span>=<span style="color: #000000;"> bool2;
        paramArrayOfFREObject.printStackTrace();
        paramArrayOfFREObject </span>=<span style="color: #000000;"> str;
        </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;
        </span><span style="color: #0000ff;">if</span> (CallSMSPay._type == 16<span style="color: #000000;">)
        {
          CallBackImpl.buyResult(paramFREContext, Boolean.valueOf(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">));
        }
        </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (CallSMSPay._type == 30<span style="color: #000000;">)
        {
          CallBackImpl.callBackMigu(paramFREContext, </span>"30"<span style="color: #000000;">);
          </span><span style="color: #0000ff;">continue</span><span style="color: #000000;">;
          Toast.makeText(paramFREContext.getActivity(), </span>"扣款失败,请尝试其它支付方式,错误码:" + paramArrayOfFREObject, 1<span style="color: #000000;">).show();
        }
      }
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IllegalStateException paramArrayOfFREObject)
    {
      </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (;;)
      {
        bool1 </span>=<span style="color: #000000;"> bool3;
      }
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FRETypeMismatchException paramArrayOfFREObject)
    {
      </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (;;)
      {
        bool1 </span>=<span style="color: #000000;"> bool4;
      }
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FREInvalidObjectException paramArrayOfFREObject)
    {
      </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (;;)
      {
        </span><span style="color: #0000ff;">boolean</span> bool1 =<span style="color: #000000;"> bool5;
      }
    }
    Log.i(</span>"ANE", "result:" + bool1 + ",code:" +<span style="color: #000000;"> paramArrayOfFREObject);
    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bool1)
    {
      Toast.makeText(paramFREContext.getActivity(), </span>"支付成功", 1<span style="color: #000000;">).show();
      </span><span style="color: #0000ff;">if</span> (CallSMSPay._type == 1<span style="color: #000000;">)
      {
        CallBackImpl.recoverResult(paramFREContext, </span>"2"<span style="color: #000000;">);
        Util.stopWaiting();
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;
      }
    }
  }
}</span></span></pre>
</div>
<span class="cnblogs_code_collapse" style="font-size: 16px;">Java伪代码</span></div>
<p><span style="font-size: 16px;">之后，我没有放弃，继续去查了一下咪咕的官方开发文档资料，不过没有方法下手</span></p>
<p><span style="font-size: 16px;">想了想，还是回到了CallSMSPay$3这个smali文件，既然找不到支付成功的代码，那就把这个正在支付这些代码当作支付成功的代码，修改switch语句，让其一定跳转到pswitch_2这里</span></p>
<p><span style="font-size: 16px;">因为pswitch_2即是正在支付的那个过程</span></p>
<p><img src="https://images2018.cnblogs.com/blog/1210268/201806/1210268-20180626215643342-277211437.png" alt="" /></p>
<p><img src="https://images2018.cnblogs.com/blog/1210268/201806/1210268-20180626215700090-1910073440.png" alt="" /></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px;">之后测试的时候，奇迹发生了，成功了！！我的心情真的是爽了！！</span></p>
<p><span style="font-size: 16px;">不过，还没有完，咪咕游戏一般有较多的广告，这个我也得想办法破掉。</span></p>
<p><span style="font-size: 16px;">首先，是退出界面的时候，会弹出两次对话框，一次是正宗的对话框，（即带有确定和取消两个选项的对话框），之后选择确定之后，它还会出现一个咪咕班的对话框，上面就是有着广告，带有两个按钮，退出游戏和返回，这时候点击退出游戏才是真正的退出游戏</span></p>
<p>我去观察了一下里面的代码，发现了四个关键文件，如下图</p>
<p><img src="https://images2018.cnblogs.com/blog/1210268/201806/1210268-20180627083511321-1643142690.png" alt="" /></p>
<p><span style="font-size: 16px;">通过代码，再结合Android开发中的对话框代码，ExitGame$1里面是点击确定按钮所要执行的代码，ExitGame$2则是点击取消按钮所要执行的代码</span></p>
<p><span style="font-size: 16px;">按照我们刚才的逻辑，我们点击确定之后，还会出现一个咪咕版的对话框（带有广告），这代码肯定是在ExitGame$1这里面，我们进去就可以看到，下面绿色的字体就是打开咪咕对话框的关键代码，我们将这些代码注释掉，之后加上红色的那一行，这一行的原java代码就是system.exit(0)，这样点击确定按钮就可以直接退出了</span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">.method public onClick(Landroid/content/DialogInterface;I)V<br />&nbsp;&nbsp;&nbsp; .locals 2<br />&nbsp;&nbsp;&nbsp; .param p1, "dialog"&nbsp;&nbsp;&nbsp; # Landroid/content/DialogInterface;<br />&nbsp;&nbsp;&nbsp; .param p2, "which"&nbsp;&nbsp;&nbsp; # I<br /><br />&nbsp;&nbsp;&nbsp; .prologue<br />&nbsp;&nbsp;&nbsp; .line 45<br />&nbsp;&nbsp;&nbsp; const/4 v0, 0x0<br /><br />&nbsp;&nbsp;&nbsp;<span style="color: #ff0000;"> invoke-static {v0}, Ljava/lang/System;-&gt;exit(I)V</span><br />&nbsp;&nbsp;&nbsp; <span style="color: #008000;">#new-instance v0, Lcom/locojoy/function/ExitGame$1$1;</span><br /><br /><span style="color: #008000;">&nbsp;&nbsp;&nbsp; #invoke-direct {v0, p0}, Lcom/locojoy/function/ExitGame$1$1;-&gt;&lt;init&gt;(Lcom/locojoy/function/ExitGame$1;)V</span><br /><br />&nbsp;&nbsp;&nbsp; .line 56<br />&nbsp;&nbsp;&nbsp; <span style="color: #008000;">#.local v0, "gameExitCallback":Lcn/cmgame/billing/api/GameInterface$GameExitCallback;</span><br /><span style="color: #008000;">&nbsp;&nbsp; # iget-object v1, p0, Lcom/locojoy/function/ExitGame$1;-&gt;val$_activity:Landroid/app/Activity;</span><br /><br /><span style="color: #008000;">&nbsp;&nbsp;&nbsp; #invoke-static {v1, v0}, Lcn/cmgame/billing/api/GameInterface;-&gt;exit(Landroid/content/Context;Lcn/cmgame/billing/api/GameInterface$GameExitCallback;)V</span><br /><br /><span style="color: #008000;">&nbsp;&nbsp;&nbsp; #.line 57</span><br />&nbsp;&nbsp;&nbsp; return-void<br />.end method</span></pre>
</div>
<p>&nbsp;</p>
<p>PS：经测试发现，删除了网络权限，就可以去弹窗广告，不能确定是否会影响购买（因为是在我是在内购成功购买之后才弄的去广告，不清楚去除网络权限是否还可以启动那个购买界面）</p>
<p>&nbsp;</p>